<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Rapids Record Club</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        .fade-in {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .album-card:hover {
            background-color: #4b5563;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
<div class="container mx-auto p-6">
    <h1 class="text-4xl font-bold text-center">Grand Rapids Record Club ðŸŽµ</h1>
    <p class="text-center mt-2">A group of friends exploring a new album each month.</p>

    <div class="text-right mt-4">
        <button id="toggleDark" class="bg-gray-700 px-4 py-2 rounded text-sm">Toggle Light/Dark</button>
    </div>

    <div id="featured-album" class="mt-6 bg-purple-700 bg-opacity-40 p-4 rounded-lg hidden">
        <h2 class="text-2xl font-bold mb-2">ðŸŽ‰ Album of the Month</h2>
        <div id="featured-content" class="flex items-center space-x-4"></div>
    </div>

    <!-- Dropdowns for filtering -->
    <div class="mt-6 flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
        <div class="flex flex-col">
            <label for="yearFilter">Year</label>
            <select id="yearFilter" class="p-2 text-black rounded" onchange="searchAlbums()">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="flex flex-col">
            <label for="genreFilter">Genre</label>
            <select id="genreFilter" class="p-2 text-black rounded" onchange="searchAlbums()">
                <option value="">All Genres</option>
            </select>
        </div>
        <div class="flex flex-col">
            <label for="hostFilter">Host</label>
            <select id="hostFilter" class="p-2 text-black rounded" onchange="searchAlbums()">
                <option value="">All Hosts</option>
            </select>
        </div>
    </div>

    <div class="mt-4">
        <input type="text" id="searchBar" class="w-full p-2 text-black rounded" placeholder="Search for an album..." oninput="searchAlbums()">
    </div>

    <div id="album-container" class="mt-4"></div>

    <!-- Modal for displaying album details -->
    <div id="album-details-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex justify-center items-center">
        <div class="bg-gray-900 p-6 rounded-lg max-w-3xl text-center">
            <img id="album-cover" class="w-48 h-48 mx-auto rounded mb-4" src="" alt="Album Cover">
            <div id="album-details-content" class="text-white"></div>
            <button onclick="closeModal()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Close</button>
        </div>
    </div>
</div>

<script>
const API_KEY_LASTFM = "33ba6c5c9f098d1131ad8cd253b17e26";
const API_KEY_GOOGLE_SHEETS = "AIzaSyB3A46Jlef2icSX7TYbze7vXsDQNwjK5bU";
const SPREADSHEET_ID = '158c3cfSIg4AX8qOARaSioQikc3CRX2psWyFRhHI9H3U';
const RANGE = 'Sheet1!A1:G100';

let albums = [];
const albumImageCache = new Map();

async function fetchAlbumsFromSheet() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY_GOOGLE_SHEETS}`;
    const response = await fetch(url);
    const data = await response.json();
    const rows = data.values;

    if (!rows || rows.length <= 1) return;

    albums = rows.slice(1).filter(row => row.length >= 9).map(row => ({
        month: row[3],
        year: row[2],
        artist: row[5],
        title: row[4],
        hostedBy: row[1],
        releaseDate: row[7],
        genre: row[6],
        meetingNumber: row[0],
        spotifyURL: row[8]
    }));

    albums.sort((a, b) => new Date(`${b.month} 1, ${b.year}`) - new Date(`${a.month} 1, ${a.year}`));

    populateDropdowns();
    displayAlbums();
}

function populateDropdowns() {
    const yearDropdown = document.getElementById("yearFilter");
    const genreDropdown = document.getElementById("genreFilter");
    const hostDropdown = document.getElementById("hostFilter");

    [yearDropdown, genreDropdown, hostDropdown].forEach(dropdown => dropdown.innerHTML = '<option value="">All</option>');

    const years = [...new Set(albums.map(album => album.year))].sort();
    const genres = [...new Set(albums.map(album => album.genre))].sort();
    const hosts = [...new Set(albums.map(album => album.hostedBy))].sort();

    years.forEach(year => yearDropdown.innerHTML += `<option value="${year}">${year}</option>`);
    genres.forEach(genre => genreDropdown.innerHTML += `<option value="${genre}">${genre}</option>`);
    hosts.forEach(host => hostDropdown.innerHTML += `<option value="${host}">${host}</option>`);
}

async function fetchAlbumDetails(title, artist) {
    const key = `${artist} - ${title}`;
    if (albumImageCache.has(key)) return albumImageCache.get(key);

    try {
        const url = `https://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=${API_KEY_LASTFM}&artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(title)}&format=json`;
        const response = await fetch(url);
        const data = await response.json();

        const image = data?.album?.image?.[3]?.['#text'] || "default_album_cover.jpg";
        const summary = data?.album?.wiki?.summary || "No description available.";

        const details = { image, summary };
        albumImageCache.set(key, details);
        return details;
    } catch (e) {
        console.error("Error fetching album details:", e);
        return { image: "default_album_cover.jpg", summary: "No description available." };
    }
}

async function displayAlbums(filteredAlbums = albums) {
    const albumContainer = document.getElementById("album-container");
    const featured = document.getElementById("featured-album");
    const featuredContent = document.getElementById("featured-content");
    albumContainer.innerHTML = "";

    const now = new Date();
    const thisMonth = now.toLocaleString('default', { month: 'long' });
    const thisYear = now.getFullYear().toString();
    const currentPick = filteredAlbums.find(a => a.month === thisMonth && a.year === thisYear);
    const latest = currentPick || filteredAlbums[0];

    if (latest) {
        const { image } = await fetchAlbumDetails(latest.title, latest.artist);
        featuredContent.innerHTML = `
            <img src="${image}" class="w-20 h-20 rounded">
            <div>
                <h3 class="text-xl">${latest.title} - ${latest.artist}</h3>
                <p class="text-sm">${latest.month} ${latest.year} â€¢ Hosted by ${latest.hostedBy}</p>
                <a href="${latest.spotifyURL || 'https://open.spotify.com/'}" target="_blank" class="text-blue-300 underline">Listen on Spotify</a>
            </div>
        `;
        featured.classList.remove("hidden");
    } else {
        featured.classList.add("hidden");
    }

    for (const album of filteredAlbums) {
        const { image } = await fetchAlbumDetails(album.title, album.artist);
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-3 rounded-lg flex items-center space-x-4 cursor-pointer fade-in album-card";
        div.onclick = () => showAlbumDetails(album);

        div.innerHTML = `
            <img src="${image}" class="w-16 h-16 rounded">
            <p>${album.month} ${album.year}: ${album.title} - ${album.artist}</p>
        `;
        albumContainer.appendChild(div);
    }
}

function searchAlbums() {
    const year = document.getElementById("yearFilter").value.toLowerCase();
    const genre = document.getElementById("genreFilter").value.toLowerCase();
    const host = document.getElementById("hostFilter").value.toLowerCase();
    const searchText = document.getElementById("searchBar").value.toLowerCase();

    const filtered = albums.filter(album => {
        const matchesYear = !year || album.year.toLowerCase() === year;
        const matchesGenre = !genre || album.genre.toLowerCase() === genre;
        const matchesHost = !host || album.hostedBy.toLowerCase() === host;
        const matchesSearch = !searchText ||
            album.title.toLowerCase().includes(searchText) ||
            album.artist.toLowerCase().includes(searchText) ||
            album.genre.toLowerCase().includes(searchText) ||
            album.hostedBy.toLowerCase().includes(searchText);

        return matchesYear && matchesGenre && matchesHost && matchesSearch;
    });

    displayAlbums(filtered);
}

async function showAlbumDetails(album) {
    const { image, summary } = await fetchAlbumDetails(album.title, album.artist);
    document.getElementById("album-cover").src = image;
    document.getElementById("album-details-content").innerHTML = `
        <h2 class="text-2xl font-bold">${album.title} - ${album.artist}</h2>
        <p><strong>Release Date:</strong> ${album.releaseDate}</p>
        <p><strong>Genre:</strong> ${album.genre}</p>
        <p><strong>Hosted By:</strong> ${album.hostedBy}</p>
        <p><strong>Meeting Number:</strong> ${album.meetingNumber}</p>
        <a href="${album.spotifyURL || 'https://open.spotify.com/'}" target="_blank" class="text-blue-500">Listen on Spotify</a>
        <br>
        <p><strong>Album Info:</strong> ${summary}</p>
    `;
    document.getElementById("album-details-modal").classList.remove("hidden");
}

function closeModal() {
    document.getElementById("album-details-modal").classList.add("hidden");
}

document.getElementById("toggleDark").addEventListener("click", () => {
    document.body.classList.toggle("bg-gray-900");
    document.body.classList.toggle("bg-white");
    document.body.classList.toggle("text-white");
    document.body.classList.toggle("text-black");
});

fetchAlbumsFromSheet();
</script>
</body>
</html>